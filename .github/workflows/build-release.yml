name: Build and Release Chrome Extension

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build extension
      run: npm run build

    - name: Package extension
      run: |
        cd dist
        zip -r ../countdown-bypass-extension.zip .

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d-%H-%M-%S')" >> $GITHUB_OUTPUT

    - name: Get version from manifest
      id: manifest
      run: echo "version=$(jq -r '.version' manifest.json)" >> $GITHUB_OUTPUT

    - name: Delete existing release (if exists)
      run: |
        # Check if release exists and delete it
        if gh release view latest 2>/dev/null; then
          echo "Deleting existing latest release..."
          gh release delete latest --yes
        else
          echo "No existing release to delete"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create new release
      run: |
        gh release create latest ./countdown-bypass-extension.zip \
          --title "Countdown Bypass Extension v${{ steps.manifest.outputs.version }} (${{ steps.date.outputs.date }})" \
          --notes "## Countdown Bypass Extension

        **Version:** ${{ steps.manifest.outputs.version }}
        **Build Date:** ${{ steps.date.outputs.date }}
        **Commit:** ${{ github.sha }}

        ### What's New
        - Automatic countdown bypass for multiple websites
        - Instant redirects and timer skips
        - Lightweight and fast Chrome extension

        ### Installation
        1. Download the \`countdown-bypass-extension.zip\` file
        2. Unzip the contents
        3. Go to \`chrome://extensions/\`
        4. Enable \"Developer mode\"
        5. Click \"Load unpacked\" and select the unzipped folder"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}